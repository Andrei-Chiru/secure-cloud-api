<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Embed & Search — Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ---------- Night mode palette & base styles ---------- */
    :root{
      --bg:#0b0f14; --panel:#141a22; --text:#e5eef8; --muted:#93a2b7;
      --border:#1f2a36; --accent:#4da3ff; --accent-2:#2d75c9; --ok:#4cd964;
      --input:#0f1621; --code:#0d1420;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:radial-gradient(1200px 800px at 10% -10%,#0f1724 0%,var(--bg) 45%) no-repeat fixed;
      max-width:980px;
    }
    nav{margin-bottom:16px}
    nav a{
      color:var(--text); opacity:.9; text-decoration:none; margin-right:14px;
      padding:6px 10px; border:1px solid var(--border); border-radius:8px;
      background:linear-gradient(180deg,#1a2230,#121824)
    }
    nav a:hover{opacity:1;border-color:#2a3950}
    h1{margin:0 0 8px;font-size:26px}
    code{background:var(--code);color:var(--text);padding:2px 6px;border-radius:6px}
    fieldset{
      border:1px solid var(--border); background:linear-gradient(180deg,#121a27,#0e1520);
      padding:16px; margin:12px 0; border-radius:12px
    }
    legend{padding:0 6px;color:var(--muted)}
    label{display:block;margin:8px 0 6px;font-size:13px;color:var(--muted)}
    input,textarea,select{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border); background:var(--input); color:var(--text); outline:none
    }
    textarea{min-height:100px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px #4da3ff33}
    button{
      padding:10px 14px; border-radius:10px; border:1px solid #2a3b54;
      background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff;
      cursor:pointer; font-weight:600
    }
    button:hover{filter:brightness(1.05)}
    .row{display:flex;gap:12px;align-items:center}.row>*{flex:1}
    .muted{color:var(--muted);font-size:12px;margin-top:8px}
    #results>div{
      padding:12px; border:1px solid var(--border); border-radius:10px;
      margin-bottom:10px; background:linear-gradient(180deg,#121a27,#0e1520)
    }
    .score{color:var(--ok)}
    .cols{display:flex;gap:12px;flex-wrap:wrap}
    .cols>div{flex:1 1 420px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hint{font-size:12px;color:var(--muted);margin-top:4px}
    ul.flat{list-style:none;padding:0;margin:8px 0}
    ul.flat li{padding:6px 0;border-bottom:1px dashed var(--border)}
  </style>
</head>
<body>
  <!-- ---------- Simple navbar ---------- -->
  <nav>
    <a href="/">Search</a>
    <a href="/collections.html">Manage collections</a>
    <a href="/ui" target="_blank">Swagger UI</a>
  </nav>

  <h1>Embed & Search</h1>
  <div class="muted">Backend base: <code id="base"></code></div>

  <!-- =======================
       Global: API key + active collection
       ======================= -->
  <fieldset>
    <legend>Settings</legend>
    <div class="row">
      <div>
        <label>API Key (X-API-Key)</label>
        <input id="key" value="dev-key" />
        <div class="hint">The key is sent as the <code>X-API-Key</code> header on every request.</div>
      </div>
      <div>
        <label>Active collection</label>
        <input id="cid" placeholder="e.g. demo or kb-ml" />
        <div class="hint">Used by “Add item” and “Search”. You can create a new collection below.</div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <!-- Seeds are great for a quick demo; left here on purpose -->
      <button onclick="seed()">Seed demo items (into active)</button>
      <button onclick="seedBig()">Seed bigger demo (creates kb-ml/cloud/python)</button>
      <button onclick="listCollections()">List collections</button>
    </div>
    <div id="status" class="muted"></div>
  </fieldset>

  <!-- =======================
       New: Dedicated "Create collection" panel
       ======================= -->
  <fieldset>
    <legend>Create collection</legend>
    <div class="row">
      <div>
        <label>Collection name</label>
        <input id="newName" placeholder="e.g. My Notes" oninput="previewSlug()" />
        <div class="hint">Name will be slugified to lowercase-with-hyphens.</div>
      </div>
      <div>
        <label>Description (optional)</label>
        <input id="newDesc" placeholder="Short description…" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <div class="hint">Slug preview: <code id="slugPreview" class="mono">n/a</code></div>
      </div>
      <div style="text-align:right">
        <button onclick="createCollection()">Create collection</button>
      </div>
    </div>
    <div class="hint">After creation, the new collection becomes the active one.</div>
    <div id="collectionsBox" class="muted" style="margin-top:10px">
      <!-- Will be filled by listCollections() -->
    </div>
  </fieldset>

  <div class="cols">
    <!-- ---------- Manual item insertion panel ---------- -->
    <div>
      <fieldset>
        <legend>Add item (manual)</legend>
        <label>Item ID</label>
        <input id="itemId" placeholder="unique id, e.g. 1 or doc-123" />
        <label>Text</label>
        <textarea id="itemText" placeholder="The text to embed and index..."></textarea>
        <label>Metadata (JSON, optional)</label>
        <textarea id="itemMeta" placeholder='{"tag":"note","source":"manual"}'></textarea>
        <div style="margin-top:10px"><button onclick="addItem()">Add item to active collection</button></div>
        <div class="muted">Tip: leave metadata empty if you don’t need it.</div>
      </fieldset>
    </div>

    <!-- ---------- Search panel ---------- -->
    <div>
      <fieldset>
        <legend>Search</legend>
        <label>Query</label>
        <input id="q" value="French capital city" />
        <label style="margin-top:8px">Top K</label>
        <select id="k"><option>3</option><option>5</option><option>10</option></select>
        <div style="margin-top:12px"><button onclick="run()">Search active collection</button></div>
      </fieldset>
    </div>
  </div>

  <!-- ---------- Results ---------- -->
  <h3 style="margin-top:18px">Results</h3>
  <div id="results" class="muted">No results yet.</div>

  <script>
    /* =======================
       Small helper utilities
       ======================= */

    // Assume API is same-origin (works for Docker & Cloud Run without CORS issues)
    const BASE = window.location.origin;
    document.getElementById('base').textContent = BASE;

    // Build headers with API key from the input.
    function headers() {
      return {
        "Content-Type": "application/json",
        "X-API-Key": document.getElementById('key').value.trim()
      };
    }

    // Read the value of a field by id.
    function val(id){ return document.getElementById(id).value.trim(); }

    // Update the little status line under Settings.
    function setStatus(msg){ document.getElementById('status').textContent = msg; }

    // Escape text for safe HTML display.
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    // Slugify (for UX preview only). Server also normalizes.
    function slugify(s){
      return (s || "")
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s-]/g, "")  // drop non-url-friendly chars
        .replace(/\s+/g, "-")          // spaces -> hyphens
        .replace(/-+/g, "-");          // collapse repeats
    }

    function previewSlug(){
      const raw = val('newName');
      const slug = slugify(raw) || "n/a";
      document.getElementById('slugPreview').textContent = slug;
    }

    // Normalize various possible server response shapes into an array of rows.
    // Accepts:
    //   - an array:             [ {...}, {...} ]
    //   - an object with key:   { results: [...] } / { matches: [...] } / { items: [...] } / { data: [...] }
    function normalizeResults(json) {
      if (Array.isArray(json)) return json;
      if (json && typeof json === 'object') {
        if (Array.isArray(json.results)) return json.results;
        if (Array.isArray(json.matches)) return json.matches;
        if (Array.isArray(json.items))   return json.items;
        if (Array.isArray(json.data))    return json.data;
      }
      return []; // fallback
    }

    /* =======================
       Collections management
       ======================= */

    // Create a new collection using the dedicated form (name + optional description).
    // After creation:
    //   * we set the "active collection" field to the new name,
    //   * and refresh the list of collections.
    async function createCollection() {
      const nameRaw = val('newName');
      if (!nameRaw) { setStatus("Please enter a collection name."); return; }

      // Display slug to the user, but server will also normalize.
      const name = slugify(nameRaw);
      const desc = val('newDesc') || null;

      const r = await fetch(`${BASE}/collections`, {
        method: "POST",
        headers: headers(),
        body: JSON.stringify({ name, description: desc })
      });

      // Report result and adopt it as the "active" collection if success
      setStatus(`POST /collections → ${r.status}`);
      if (r.ok) {
        // Set the active collection field so Add/Search panels use it
        document.getElementById('cid').value = name;
        // Clear create form
        document.getElementById('newName').value = "";
        document.getElementById('newDesc').value = "";
        previewSlug();
        // Show the refreshed list
        await listCollections();
      } else {
        const t = await r.text().catch(()=>"(no body)");
        setStatus(`Create error ${r.status}: ${t}`);
      }
    }

    // Render the list of collections into the "collectionsBox" panel (nice for reviewers).
    function renderCollections(list){
      const box = document.getElementById('collectionsBox');
      if (!Array.isArray(list) || list.length === 0) {
        box.innerHTML = "<div>No collections yet.</div>";
        return;
      }
      const items = list.map(c => (
        `<li><strong>${escapeHtml(c.name)}</strong> <span class="muted">(id: ${c.id})</span> — ${escapeHtml(c.description || "")}</li>`
      )).join("");
      box.innerHTML = `<div>Existing collections:</div><ul class="flat">${items}</ul>`;
    }

    // Fetch and render all collections. Also drop a summary in the status line.
    async function listCollections(){
      const r = await fetch(`${BASE}/collections`, { headers: headers() });
      if (!r.ok) { setStatus(`/collections → ${r.status}`); return; }
      const list = await r.json().catch(()=>[]);
      renderCollections(list);
      const txt = list.map(c => `${c.name}(id:${c.id})`).join(", ");
      setStatus(`Collections: ${txt || "none"}`);
    }

    /* =======================
       Seeding helpers (kept for quick demos)
       ======================= */

    // Small, known-good 3-item dataset for quick smoke tests (into active collection).
    async function seed() {
      const cid = val('cid') || "demo";
      const items = [
        { id: "1", text: "Paris is the capital of France", metadata: { tag: "geo" } },
        { id: "2", text: "The Eiffel Tower is in Paris",  metadata: { tag: "landmark" } },
        { id: "3", text: "Tokyo is the capital of Japan", metadata: { tag: "geo" } },
      ];
      const r = await fetch(`${BASE}/collections/${encodeURIComponent(cid)}/index`, {
        method: "POST", headers: headers(), body: JSON.stringify({ items })
      });
      const ok = r.ok ? "✅" : "❌";
      setStatus(`POST /collections/${cid}/index → ${r.status} ${ok}`);
      if (!r.ok) {
        const t = await r.text().catch(()=>"(no body)");
        setStatus(`Seed error ${r.status}: ${t}`);
      }
    }

    // Bigger example across 3 topic collections (creates kb-ml, kb-cloud, kb-python).
    async function seedBig(){
      const post = async (u,b) => {
        const r = await fetch(u,{ method:"POST", headers:headers(), body:JSON.stringify(b) });
        if (!r.ok) throw new Error(`${u} → ${r.status} ${await r.text()}`);
      };
      try {
        await post(`${BASE}/collections`, {name:"kb-ml",     description:"Machine learning notes"}).catch(()=>{});
        await post(`${BASE}/collections`, {name:"kb-cloud",  description:"Cloud architecture notes"}).catch(()=>{});
        await post(`${BASE}/collections`, {name:"kb-python", description:"Python tips"}).catch(()=>{});

        await post(`${BASE}/collections/kb-ml/index`, { items: [
          {"id":"ml-01","text":"Cross-entropy loss measures the distance between true and predicted distributions.","metadata":{"topic":"metrics"}},
          {"id":"ml-02","text":"Batch normalization stabilizes training using batch statistics.","metadata":{"topic":"optimization"}},
          {"id":"ml-03","text":"Adam uses first/second-moment gradient estimates (AdamW improves generalization).","metadata":{"topic":"optimizers"}}
        ]});

        await post(`${BASE}/collections/kb-cloud/index`, { items: [
          {"id":"cl-01","text":"S3 is an object store; use lifecycle policies for cost control.","metadata":{"aws":"s3"}},
          {"id":"cl-02","text":"EC2 spot instances are interruptible; design for resilience.","metadata":{"aws":"ec2"}}
        ]});

        await post(`${BASE}/collections/kb-python/index`, { items: [
          {"id":"py-01","text":"List comprehensions are concise and fast.","metadata":{"topic":"syntax"}},
          {"id":"py-02","text":"Generators produce values lazily via yield.","metadata":{"topic":"iterators"}}
        ]});

        // Refresh the rendered list so reviewers see the new collections
        await listCollections();
        setStatus("Seeded bigger demo ✅");
      } catch (e) {
        setStatus(`SeedBig error: ${e.message}`);
      }
    }

    /* =======================
       Add item to active collection
       ======================= */

    async function addItem(){
      const cid  = val('cid') || "demo";
      const id   = val('itemId');
      const text = val('itemText');

      // Validate required fields
      if (!id || !text) { setStatus("Please provide both Item ID and Text."); return; }

      // Parse metadata only if provided
      let metadata = undefined;
      const raw = val('itemMeta');
      if (raw) {
        try { metadata = JSON.parse(raw); }
        catch { setStatus("Metadata must be valid JSON"); return; }
      }

      // Build payload; omit 'metadata' key when undefined to avoid validation errors
      const item = { id, text };
      if (metadata !== undefined) item.metadata = metadata;

      const r = await fetch(`${BASE}/collections/${encodeURIComponent(cid)}/index`, {
        method: "POST", headers: headers(), body: JSON.stringify({ items: [ item ] })
      });

      setStatus(`POST /collections/${cid}/index → ${r.status}`);
      if (r.ok) {
        // Clear fields on success for faster manual entry of next item
        document.getElementById('itemId').value = "";
        document.getElementById('itemText').value = "";
        document.getElementById('itemMeta').value = "";
      } else {
        // Surface any error body to help debugging
        const t = await r.text().catch(()=>"(no body)");
        setStatus(`Index error ${r.status}: ${t}`);
      }
    }

    /* =======================
       Search active collection
       ======================= */

    async function run() {
      const cid  = val('cid') || "demo";
      const body = {
        query: val('q'),
        top_k: parseInt(val('k'),10) || 3
      };

      const r = await fetch(`${BASE}/collections/${encodeURIComponent(cid)}/search`, {
        method: "POST", headers: headers(), body: JSON.stringify(body)
      });

      // Read raw text first so we can both parse and show it if parsing fails
      const text = await r.text();
      let json;
      try { json = JSON.parse(text); }
      catch { json = null; }

      const rows = normalizeResults(json ?? []);
      setStatus(`POST /collections/${cid}/search → ${r.status}  (hits: ${rows.length})`);

      renderResults(rows);
    }

    // Render normalized rows to the page.
    function renderResults(rows) {
      const out = document.getElementById('results');
      out.innerHTML = "";
      if (!rows.length) { out.textContent = "No results."; return; }

      rows.forEach((rec, i) => {
        // Support different field names; fall back defensively
        const score = typeof rec.score === "number" ? rec.score
                    : (typeof rec.similarity === "number" ? rec.similarity
                    : (typeof rec.distance === "number" ? (1 - rec.distance) : 0));

        const text  = rec.text ?? rec.body ?? rec.content ?? JSON.stringify(rec);
        const meta  = rec.metadata ?? rec.meta ?? null;

        const div = document.createElement('div');
        div.innerHTML = `
          <strong>#${i + 1}</strong>
          — <span class="score">${(score || 0).toFixed(4)}</span>
          ${rec.id ? `<span class="muted mono"> (id: ${escapeHtml(String(rec.id))})</span>` : ""}
          <div style="margin-top:6px">${escapeHtml(String(text))}</div>
          <div class="muted mono" style="margin-top:6px">${escapeHtml(JSON.stringify(meta))}</div>
        `;
        out.appendChild(div);
      });
    }

    // On first load, show the existing collections (useful on Cloud Run)
    document.addEventListener('DOMContentLoaded', listCollections);
    // Read key from cookie or URL and keep it in a cookie; remove it from the URL for safety.
    function getCookie(name){
      return document.cookie.split('; ').find(r => r.startsWith(name+'='))?.split('=')[1];
    }
    function setCookie(name, value){
      // non-HttpOnly because the page needs to read it; secure + samesite for safety
      document.cookie = `${name}=${value}; path=/; secure; samesite=Strict; max-age=2592000`; // 30 days
    }
    function adoptKeyFromUrl() {
      const url = new URL(window.location.href);
      const fromUrl = url.searchParams.get('key');
      if (fromUrl) {
        setCookie('x_api_key', fromUrl);
        url.searchParams.delete('key');
        window.history.replaceState({}, "", url.toString()); // cleans the visible URL
      }
    }
    function populateKeyInput() {
      const existing = getCookie('x_api_key');
      if (existing) document.getElementById('key').value = existing;
    }
    document.addEventListener('DOMContentLoaded', () => {
      adoptKeyFromUrl();
      populateKeyInput();
      // keep cookie up to date as the user edits the key
      document.getElementById('key').addEventListener('change', e => setCookie('x_api_key', e.target.value.trim()));
    });
  </script>
</body>
</html>
